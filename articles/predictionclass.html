<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prediction model class (`learner`) • targeted</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Prediction model class (`learner`)">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">targeted</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/predictionclass.html">Prediction model class (`learner`)</a>
    </li>
    <li>
      <a href="../articles/riskregression.html">Estimating a relative risk or risk difference with a binary exposure</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kkholst/targeted/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Prediction model class
(<code>learner</code>)</h1>
                        <h4 data-toc-skip class="author">Klaus Kähler
Holst, Benedikt Sommer</h4>
            
            <h4 data-toc-skip class="date">2025-07-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/kkholst/targeted/blob/deploy/vignettes/predictionclass.Rmd" class="external-link"><code>vignettes/predictionclass.Rmd</code></a></small>
      <div class="hidden name"><code>predictionclass.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Methods for targeted and semiparametric inference rely on fitting
nuisance models to observed data when estimating the target parameter of
interest. The <a href="https://kkholst.github.io/targeted/" class="external-link">targeted</a> package implements the <a href="https://r6.r-lib.org/" class="external-link">R6 reference class</a> <code>learner</code>
to harmonize common statistical and machine learning models for the
usage as nuisance models across the various implemented estimators.
Commonly used models are constructed as <code>learner</code> class
objects through the <code>learner_</code> functions. These functions are
wrappers for statistical and machine learning models that have been
implemented in other R packages. This is conceptually similar to
packages such as <a href="https://github.com/topepo/caret/" class="external-link">caret</a> and <a href="https://mlr3.mlr-org.com" class="external-link">mlr3</a>. Besides
implementing a large number of prediction models, these packages provide
extensive functionalities for data preprocessing, model selection and
diagnostics, and hyper-parameter optimization. The design of the
<code>learner</code> class and accompanied functions is much leaner, as
our use-cases often only require a standardized interface for estimating
models and generating predictions, instead of the full predictive
modelling pipeline.</p>
<p>This vignette uses the Mayo Clinic Primary Biliary Cholangitis data
(<code><a href="https://rdrr.io/pkg/survival/man/pbc.html" class="external-link">?survival::pbc</a></code>) to exemplify the usage of the
<code>learner</code> class objects. Our interest lies in the prediction
of the composite event of death or transplant before 2 years.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">pbc</span>, package<span class="op">=</span><span class="st">"survival"</span><span class="op">)</span></span>
<span><span class="va">pbc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">pbc</span>, y <span class="op">=</span> <span class="op">(</span><span class="va">time</span> <span class="op">&lt;</span> <span class="fl">730</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">status</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>A logistic regression model with a single <code>age</code> covariate
is defined and estimated via</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/learner_glm.html">learner_glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">age</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">estimate</span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span></span></code></pre></div>
<p>and predictions for the event <code>y = 1</code> (class 2
probabilities) for new data are obtained by</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">40</span>, <span class="fl">60</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;          1          2          3          4 </span></span>
<span><span class="co">#&gt; 0.02578001 0.06868011 0.17047725 0.36415988</span></span></code></pre></div>
<p>The remainder of this vignette is structured as follows. We first
provide more details about the built-in learners that wrap statistical
and machine learning models from other R packages. Once the usage of the
returned <code>learner</code> class objects has been introduced, we
provide details to implement new learners.</p>
</div>
<div class="section level2">
<h2 id="built-in-learners">Built-in learners<a class="anchor" aria-label="anchor" href="#built-in-learners"></a>
</h2>
<p>The various constructors for commonly used statistical and machine
learning models are listed as part of the <code>learner</code> class
documentation</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">learner</span> <span class="co"># help(learner)</span></span></code></pre></div>
<p>which contains all essential information for the usage of the
<code>learner</code> class objects. With the exception of
<code>learner_sl</code>, all constructors require a <code>formula</code>
argument that specify the response vector and design matrix for the
underlying model. This way the construction of a learner is separated
from the estimation of the model, as shown in the above logistic
regression example. A result of this design is the convenient
specification of ensemble learners (superlearner), where individual
learners operate on different subsets of features.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr_sl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/learner_sl.html">learner_sl</a></span><span class="op">(</span></span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    glm1 <span class="op">=</span> <span class="fu"><a href="../reference/learner_glm.html">learner_glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">age</span> <span class="op">*</span> <span class="va">bili</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span>,</span>
<span>    glm2 <span class="op">=</span> <span class="fu"><a href="../reference/learner_glm.html">learner_glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">age</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span>,</span>
<span>    gam <span class="op">=</span> <span class="fu"><a href="../reference/learner_gam.html">learner_gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">bili</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">lr_sl</span><span class="op">$</span><span class="fu">estimate</span><span class="op">(</span><span class="va">pbc</span>, nfolds <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">lr_sl</span></span>
<span><span class="co">#&gt; ────────── learner object ──────────</span></span>
<span><span class="co">#&gt; superlearner</span></span>
<span><span class="co">#&gt;  glm1</span></span>
<span><span class="co">#&gt;  glm2</span></span>
<span><span class="co">#&gt;  gam </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate arguments: learners=&lt;list&gt;, nfolds=5, meta.learner=&lt;function&gt;, model.score=&lt;function&gt; </span></span>
<span><span class="co">#&gt; Predict arguments:   </span></span>
<span><span class="co">#&gt; Formula: y ~ age * bili </span></span>
<span><span class="co">#&gt; ─────────────────────────────────────</span></span>
<span><span class="co">#&gt;           score   weight</span></span>
<span><span class="co">#&gt; glm1 0.09812212 0.270091</span></span>
<span><span class="co">#&gt; glm2 0.10869420 0.000000</span></span>
<span><span class="co">#&gt; gam  0.09639324 0.729909</span></span></code></pre></div>
<p>Most constructors have additional arguments that impact the resulting
model fit, ranging from the specification of a link function for
generalized linear models to hyper hyperparameters of machine learning
models. Arguments naturally vary between the constructors and are
documented for each function (e.g. <code><a href="../reference/learner_gam.html">?learner_gam</a></code>). The
implemented constructors only provide arguments for the most relevant
parameters of the underlying fit function (<code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">mgcv::gam</a></code> in
case of <code>learner_gam</code>). As described in the documentation,
the ellipsis argument (<code>...</code>) can be used to pass additional
arguments to the fit function. However, in most situations this is
rarely required.</p>
<p>It is often necessary to consider a range of models with different
hyper-parameters and to facilitate this we can use the
<code>learner_expand_grid</code> function</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/learner_expand_grid.html">learner_expand_grid</a></span><span class="op">(</span> <span class="va">learner_xgboost</span>,</span>
<span>                            <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>                                eta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">lrs</span></span>
<span><span class="co">#&gt; $`xgboost reg:squarederror`</span></span>
<span><span class="co">#&gt; ────────── learner object ──────────</span></span>
<span><span class="co">#&gt; xgboost reg:squarederror </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate arguments: max_depth=2, eta=0.2, nrounds=2, subsample=1, lambda=1, verbose=0, objective=reg:squarederror </span></span>
<span><span class="co">#&gt; Predict arguments:   </span></span>
<span><span class="co">#&gt; Formula: Sepal.Length ~ . </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`xgboost reg:squarederror.1`</span></span>
<span><span class="co">#&gt; ────────── learner object ──────────</span></span>
<span><span class="co">#&gt; xgboost reg:squarederror </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate arguments: max_depth=2, eta=0.5, nrounds=2, subsample=1, lambda=1, verbose=0, objective=reg:squarederror </span></span>
<span><span class="co">#&gt; Predict arguments:   </span></span>
<span><span class="co">#&gt; Formula: Sepal.Length ~ . </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`xgboost reg:squarederror.2`</span></span>
<span><span class="co">#&gt; ────────── learner object ──────────</span></span>
<span><span class="co">#&gt; xgboost reg:squarederror </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate arguments: max_depth=2, eta=0.3, nrounds=2, subsample=1, lambda=1, verbose=0, objective=reg:squarederror </span></span>
<span><span class="co">#&gt; Predict arguments:   </span></span>
<span><span class="co">#&gt; Formula: Sepal.Length ~ .</span></span></code></pre></div>
<p>The list of models can then serve as inputs for
<code>predictor_sl</code> or for assessing the generalization error of
the model across different hyper-parameters with the <code>cv</code>
method.</p>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>The basic usage is to construct a new learner by providing the
<code>formula</code> argument and the set of additional parameters that
control the model fitting process and the task (binary classification in
this example).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr_xgboost</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/learner_xgboost.html">learner_xgboost</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">bili</span>,</span>
<span>  eta <span class="op">=</span> <span class="fl">0.3</span>, nrounds <span class="op">=</span> <span class="fl">5</span>,  <span class="co"># hyperparameters</span></span>
<span>  objective <span class="op">=</span> <span class="st">"binary:logistic"</span> <span class="co"># learning task</span></span>
<span><span class="op">)</span></span>
<span><span class="va">lr_xgboost</span></span>
<span><span class="co">#&gt; ────────── learner object ──────────</span></span>
<span><span class="co">#&gt; xgboost binary:logistic </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate arguments: max_depth=2, eta=0.3, nrounds=5, subsample=1, lambda=1, verbose=0, objective=binary:logistic </span></span>
<span><span class="co">#&gt; Predict arguments:   </span></span>
<span><span class="co">#&gt; Formula: y ~ age + sex + bili</span></span></code></pre></div>
<p>The model is estimated via the <code>estimate</code> method</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr_xgboost</span><span class="op">$</span><span class="fu">estimate</span><span class="op">(</span>data <span class="op">=</span> <span class="va">pbc</span><span class="op">)</span></span></code></pre></div>
<p>The default behavior is to assign the fitted model to the learner
object, which can be accessed via</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">lr_xgboost</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "xgb.Booster"</span></span></code></pre></div>
<p>Once the model has been fitted, predictions are generated with</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr_xgboost</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.5164376 0.1311248 0.3392217 0.1311248 0.1655048 0.1311248</span></span></code></pre></div>
<p>where the fitted model is used inside the learner object to generate
the predictions.</p>
<p>S3 methods are implemented for the <code>learner</code> class objects
as an alternative to the R6 class syntax for fitting the model and
making predictions.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/learner_glm.html">learner_glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">age</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://kkholst.github.io/lava/reference/estimate.default.html" class="external-link">estimate</a></span><span class="op">(</span><span class="va">lr</span>, <span class="va">pbc</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">lr</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;          1          2          3          4          5          6 </span></span>
<span><span class="co">#&gt; 0.16171479 0.14624529 0.25614862 0.13566571 0.06272415 0.22071201</span></span></code></pre></div>
<div class="section level3">
<h3 id="update-formula">Update formula<a class="anchor" aria-label="anchor" href="#update-formula"></a>
</h3>
<p>The estimate and predict functions of <code>learner</code> class
objects are by design immutable. Both functions can be inspected as part
of the return values of the summary method</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr_xgboost</span><span class="op">$</span><span class="fu">summary</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="co">#&gt; function(x, y, ...) {</span></span>
<span><span class="co">#&gt;       d &lt;- xgboost::xgb.DMatrix(x, label = y)</span></span>
<span><span class="co">#&gt;       res &lt;- do.call(</span></span>
<span><span class="co">#&gt;         xgboost::xgboost,</span></span>
<span><span class="co">#&gt;         c(list(data = d), list(...)),</span></span>
<span><span class="co">#&gt;       )</span></span>
<span><span class="co">#&gt;       return(res)</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x55c15581d250&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55c157188f08&gt;</span></span></code></pre></div>
<p>Rare situations may arise where one wants to update the formula
argument. This supported and implemented via the <code>update</code>
method</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr_xgboost</span><span class="op">$</span><span class="fu">update</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span><span class="op">)</span></span></code></pre></div>
<p>The design matrix that results from by the specified formula can be
inspected via</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lr_xgboost</span><span class="op">$</span><span class="fu">design</span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;        age sexf</span></span>
<span><span class="co">#&gt; 1 58.76523    1</span></span>
<span><span class="co">#&gt; 2 56.44627    1</span></span>
<span><span class="co">#&gt; 3 70.07255    0</span></span>
<span><span class="co">#&gt; 4 54.74059    1</span></span>
<span><span class="co">#&gt; 5 38.10541    1</span></span>
<span><span class="co">#&gt; 6 66.25873    1</span></span></code></pre></div>
<p>and the response vector via</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lr_xgboost</span><span class="op">$</span><span class="fu">response</span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1 2 3 4 5 6 </span></span>
<span><span class="co">#&gt; 1 0 0 0 0 0</span></span></code></pre></div>
<p>See <code><a href="../reference/learner.html">?learner</a></code> for the differences between
<code>learner$design</code> and <code>learner$response</code> and
<code><a href="../reference/design.html">?design</a></code> for more details about the construction of the
design matrix and response vector.</p>
</div>
<div class="section level3">
<h3 id="cross-validation">Cross-validation<a class="anchor" aria-label="anchor" href="#cross-validation"></a>
</h3>
<p>The <a href="https://kkholst.github.io/targeted/" class="external-link">targeted</a> package provides a generic implementation
for repeated k-fold cross-validation with <code>learner</code> class
objects. Parallelization is supported via the <a href="https://future.futureverse.org" class="external-link">future</a> and
<code>{parallel}</code> packages (see <code><a href="../reference/cv.default.html">?cv</a></code> for more
details).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># future::plan("multicore")</span></span>
<span><span class="va">lrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  glm <span class="op">=</span> <span class="fu"><a href="../reference/learner_glm.html">learner_glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">age</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span>,</span>
<span>  gam <span class="op">=</span> <span class="fu"><a href="../reference/learner_gam.html">learner_gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">bili</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span> <span class="co"># 2 times repeated 5-fold cross-validation</span></span>
<span><span class="fu"><a href="../reference/cv.default.html">cv</a></span><span class="op">(</span><span class="va">lrs</span>, data <span class="op">=</span> <span class="va">pbc</span>, rep <span class="op">=</span> <span class="fl">2</span>, nfolds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: cv.default(object = lrs, data = pbc, nfolds = 5, rep = 2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 5-fold cross-validation with 2 repetitions</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            mse       mae</span></span>
<span><span class="co">#&gt; glm 0.10703235 0.2123702</span></span>
<span><span class="co">#&gt; gam 0.09614606 0.1858291</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="defining-new-learners">Defining new learners<a class="anchor" aria-label="anchor" href="#defining-new-learners"></a>
</h2>
<p>Statistical or machine learning models for which no constructors are
provided can be implemented with a few lines of code. In what follows we
cover three general cases where the input to the fit function
differs.</p>
<div class="section level3">
<h3 id="fit-function-with-formula-and-data-arguments">Fit function with formula and data arguments<a class="anchor" aria-label="anchor" href="#fit-function-with-formula-and-data-arguments"></a>
</h3>
<p>The first general case covers fit functions which expect a formula
and data argument. Both arguments are used then by the fitting routine
to construct the design matrix and response vector. Statistical models
are usually implement with such an interface, with examples including
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">mgcv::gam</a></code> and
<code><a href="https://rdrr.io/pkg/earth/man/earth.html" class="external-link">earth::earth</a></code>. The <code>learner</code> R6 class supports
these fitting routines by checking if the provided estimate function has
a <code>formula</code> and <code>data</code> argument. If it does, then
the <code>formula</code> and <code>data</code> argument are passed on to
the estimate function without further modifications. This is exemplified
in the following for <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm</a></code>, where we define a new
constructor to return a <code>learner</code> class object that fits a
generalized model</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_glm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va"><a href="../reference/learner.html">learner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">formula</span>,</span>
<span>    estimate <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span>,</span>
<span>    predict <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span>,</span>
<span>    predict.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>,</span>
<span>    estimate.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>,</span>
<span>    info <span class="op">=</span> <span class="st">"new glm learner"</span> <span class="co"># optional</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">lr</span> <span class="op">&lt;-</span> <span class="fu">new_glm</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">age</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="va">lr</span></span>
<span><span class="co">#&gt; ────────── learner object ──────────</span></span>
<span><span class="co">#&gt; new glm learner </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate arguments: family=binomial </span></span>
<span><span class="co">#&gt; Predict arguments: type=response </span></span>
<span><span class="co">#&gt; Formula: y ~ age</span></span></code></pre></div>
<p>It can be seen that the optional arguments of <code>new_glm</code>
define the <code>estimate.args</code> of a constructed learner object.
When estimating the model with</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span><span class="op">$</span><span class="fu">estimate</span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span></span></code></pre></div>
<p>the parameters defined in <code>estimate.args</code> are passed on
with the <code>formula</code> and <code>data</code> to
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm</a></code> (i.e. the function specified via the
<code>estimate</code> argument). Thus, the above is equivalent to</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">age</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, data <span class="op">=</span> <span class="va">pbc</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">lr</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>The code further instructs to construct a learner object that uses
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">stats::predict</a></code> to make predictions. The learner object
similarly passes on the <code>predict.args</code> to
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">stats::predict</a></code> for</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;          1          2          3          4          5          6 </span></span>
<span><span class="co">#&gt; 0.16171479 0.14624529 0.25614862 0.13566571 0.06272415 0.22071201</span></span></code></pre></div>
<p>which is equivalent to</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="co">#&gt;          1          2          3          4          5          6 </span></span>
<span><span class="co">#&gt; 0.16171479 0.14624529 0.25614862 0.13566571 0.06272415 0.22071201</span></span></code></pre></div>
<p>Indeed, the documentation of <code><a href="../reference/learner.html">?learner</a></code> reveals that the
predict method always requires an <code>object</code> and
<code>newdata</code> argument. An important implementation detail is
that the <code>learner</code> R6 class allows to overrule the defined
<code>estimate.args</code> and <code>predict.args</code> in the method
calls.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span><span class="op">$</span><span class="fu">estimate</span><span class="op">(</span><span class="va">pbc</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"link"</span><span class="op">)</span></span>
<span><span class="co">#&gt;         1         2         3         4         5         6 </span></span>
<span><span class="co">#&gt; -1.837279 -1.939001 -1.341276 -2.013822 -2.743535 -1.508572</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-function-with-x-and-y-arguments">Fit function with x and y arguments<a class="anchor" aria-label="anchor" href="#fit-function-with-x-and-y-arguments"></a>
</h3>
<p>Most fitting routines for machine learning models expect a design
matrix and response vector as inputs. The R6 <code>learner</code> class
supports these fitting functions by internally processing the
<code>formula</code> argument via the <code><a href="../reference/design.html">targeted::design</a></code>
function. Take the example of <code><a href="https://rdrr.io/pkg/grf/man/probability_forest.html" class="external-link">grf::probability_forest</a></code>,
which expects a <code>X</code> (design matrix) and <code>Y</code>
(response vector) as inputs.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_grf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va"><a href="../reference/learner.html">learner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">formula</span>,</span>
<span>    estimate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">grf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/grf/man/probability_forest.html" class="external-link">probability_forest</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">x</span>, Y <span class="op">=</span> <span class="va">y</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>    predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span>    <span class="op">}</span>,</span>
<span>    estimate.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>,</span>
<span>    info <span class="op">=</span> <span class="st">"grf::probability_forest"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">lr</span> <span class="op">&lt;-</span> <span class="fu">new_grf</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">bili</span>, num.trees <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">estimate</span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span></span></code></pre></div>
<p>Compared to the previous case, the <code>pbc</code> data object is
not directly passed on to the fit function.
Instead,<code><a href="../reference/design.html">targeted::design</a></code> constructs the design matrix and
response vector from the defined <code>formula</code> argument. As shown
previously,</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsgn</span> <span class="op">&lt;-</span> <span class="va">lr</span><span class="op">$</span><span class="fu">design</span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span></span></code></pre></div>
<p>can be used to inspect the design object. The <code>x</code> and
<code>y</code> attributes of the returned <code>design</code> object are
then passed on to the fit function.</p>
</div>
<div class="section level3">
<h3 id="fit-function-with-single-data-argument">Fit function with single data argument<a class="anchor" aria-label="anchor" href="#fit-function-with-single-data-argument"></a>
</h3>
<p>To support ensemble/meta learners, it is also possible to construct a
learner without providing a formula argument.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_sl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">learners</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va"><a href="../reference/learner.html">learner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    info <span class="op">=</span> <span class="st">"new superlearner"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">superlearner</span>,</span>
<span>    predict <span class="op">=</span> <span class="fu">targeted</span><span class="fu">:::</span><span class="va"><a href="../reference/predict.superlearner.html">predict.superlearner</a></span>,</span>
<span>    estimate.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>learners <span class="op">=</span> <span class="va">learners</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">lrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  glm <span class="op">=</span> <span class="fu"><a href="../reference/learner_glm.html">learner_glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">age</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span>,</span>
<span>  gam <span class="op">=</span> <span class="fu"><a href="../reference/learner_gam.html">learner_gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">lr</span> <span class="op">&lt;-</span> <span class="fu">new_sl</span><span class="op">(</span><span class="va">lrs</span>, nfolds <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">estimate</span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span></span>
<span><span class="va">lr</span></span>
<span><span class="co">#&gt; ────────── learner object ──────────</span></span>
<span><span class="co">#&gt; new superlearner </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimate arguments: learners=&lt;list&gt;, nfolds=2 </span></span>
<span><span class="co">#&gt; Predict arguments:   </span></span>
<span><span class="co">#&gt; Formula: NULL </span></span>
<span><span class="co">#&gt; ─────────────────────────────────────</span></span>
<span><span class="co">#&gt;         score weight</span></span>
<span><span class="co">#&gt; glm 0.1079867      1</span></span>
<span><span class="co">#&gt; gam 0.1110210      0</span></span></code></pre></div>
<p>In this case, all arguments provided to <code>lr$estimate</code> are
joined together with the specified <code>estimate.args</code> and passed
on to the defined estimate function (i.e.
<code>superlearner</code>).</p>
</div>
<div class="section level3">
<h3 id="specials-in-formula">Specials in formula<a class="anchor" aria-label="anchor" href="#specials-in-formula"></a>
</h3>
<p>Certain learner functions allow for specifying special terms in the
formula. For example, let’s consider an aggregated dataset that includes
only the response variable, treatment, and sex:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://r-datatable.com" class="external-link">"data.table"</a></span><span class="op">)</span></span>
<span><span class="va">dd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span><span class="va">.N</span><span class="op">)</span>, by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">y</span>,<span class="va">trt</span>,<span class="va">sex</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span></span>
<span><span class="co">#&gt;        y   trt    sex     N</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;int&gt; &lt;fctr&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:     1     1      f    13</span></span>
<span><span class="co">#&gt; 2:     0     1      f   124</span></span>
<span><span class="co">#&gt; 3:     0     1      m    19</span></span>
<span><span class="co">#&gt; 4:     0     2      f   123</span></span>
<span><span class="co">#&gt; 5:     1     2      f    16</span></span>
<span><span class="co">#&gt; 6:     0     2      m    12</span></span>
<span><span class="co">#&gt; 7:     1     2      m     3</span></span>
<span><span class="co">#&gt; 8:     1     1      m     2</span></span></code></pre></div>
<p>Next, we fit a Naive Bayes classifier using the <code>weights</code>
special term to specify the frequency weights for the estimation</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/learner_naivebayes.html">learner_naivebayes</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">trt</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">estimate</span><span class="op">(</span><span class="va">dd</span><span class="op">)</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">dd</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.09138473 0.09138473 0.12139346 0.11913520 0.11913520 0.15668515 0.15668515</span></span>
<span><span class="co">#&gt; [8] 0.12139346</span></span></code></pre></div>
<p>Here <code>weights.numeric</code> is simply the identity function</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">targeted</span><span class="fu">:::</span><span class="va">weights.numeric</span></span>
<span><span class="co">#&gt; function(object, ...) object</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x55c1571e37b0&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:targeted&gt;</span></span></code></pre></div>
<p>To illustrate how to define a custom learner that utilizes special
terms, consider the following example where we introduce a
<code>strata</code> term. In this case, we introduce an estimation
method that fits a linear regression model for each value of the strata
variable, as well as a corresponding prediction method</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>, <span class="va">strata</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span>, \<span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">strata</span><span class="op">==</span><span class="va">s</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">strata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">strata</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">res</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">newdata</span><span class="op">[</span><span class="va">idx</span>, <span class="op">]</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The new learner is now defined by including the argument `specials =
“strata”, which ensures that the strata variable is correctly passed to
both the estimate and predict functions</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/learner.html">learner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/strata.html" class="external-link">strata</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span>,</span>
<span>                  estimate<span class="op">=</span><span class="va">est</span>, predict<span class="op">=</span><span class="va">pred</span>, specials <span class="op">=</span> <span class="st">"strata"</span><span class="op">)</span></span>
<span><span class="va">des</span> <span class="op">&lt;-</span> <span class="va">lr</span><span class="op">$</span><span class="fu">design</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">des</span></span>
<span><span class="co">#&gt; ────────── design object ──────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; response (length: 6)     </span></span>
<span><span class="co">#&gt; 1   1</span></span>
<span><span class="co">#&gt; 2   0</span></span>
<span><span class="co">#&gt; ---  </span></span>
<span><span class="co">#&gt; 5   0</span></span>
<span><span class="co">#&gt; 6   0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; specials</span></span>
<span><span class="co">#&gt;  - strata [factor]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; design matrix (dim: 6, 1)</span></span>
<span><span class="co">#&gt;     sexf</span></span>
<span><span class="co">#&gt; 1   1   </span></span>
<span><span class="co">#&gt; 2   1   </span></span>
<span><span class="co">#&gt; ---     </span></span>
<span><span class="co">#&gt; 5   1   </span></span>
<span><span class="co">#&gt; 6   1</span></span>
<span><span class="va">des</span><span class="op">$</span><span class="va">strata</span></span>
<span><span class="co">#&gt;     1     2     3     4     5     6 </span></span>
<span><span class="co">#&gt; trt=1 trt=1 trt=1 trt=1 trt=2 trt=2 </span></span>
<span><span class="co">#&gt; Levels: trt=1 trt=2</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span><span class="op">$</span><span class="fu">estimate</span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span></span>
<span><span class="va">lr</span></span>
<span><span class="co">#&gt; ────────── learner object ──────────</span></span>
<span><span class="co">#&gt; Estimate arguments:   </span></span>
<span><span class="co">#&gt; Predict arguments:   </span></span>
<span><span class="co">#&gt; Formula: y ~ sex + strata(trt) </span></span>
<span><span class="co">#&gt; ─────────────────────────────────────</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = formula, data = data[which(strata == s), ])</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)         sexf  </span></span>
<span><span class="co">#&gt;   0.0952381   -0.0003476  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = formula, data = data[which(strata == s), ])</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)         sexf  </span></span>
<span><span class="co">#&gt;     0.20000     -0.08489</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pbc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.09489051 0.09489051 0.09523810 0.09489051 0.11510791 0.11510791</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Klaus K. Holst, Benedikt Sommer, Andreas Nordland.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
