<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Average Treatment Effects • targeted</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Average Treatment Effects">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">targeted</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ate.html">Average Treatment Effects</a>
    </li>
    <li>
      <a href="../articles/ode.html">targeted::ode_solve: Solving Ordinary Differential Equations</a>
    </li>
    <li>
      <a href="../articles/riskregression.html">Estimating a relative risk or risk difference with a binary exposure</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kkholst/targeted/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><script src="ate_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Average Treatment Effects</h1>
                        <h4 data-toc-skip class="author">Klaus Kähler Holst</h4>
            
            <h4 data-toc-skip class="date">2024-11-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/kkholst/targeted/blob/main/vignettes/ate.Rmd" class="external-link"><code>vignettes/ate.Rmd</code></a></small>
      <div class="hidden name"><code>ate.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Let <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math> be a <em>binary response</em>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math> a <em>categorical treatment</em>, and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math> a <em>vector of confounders</em>. Assume that we have observed <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math> i.i.d. observations <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">(</mo><msub><mi>Y</mi><mi>i</mi></msub><mo>,</mo><msub><mi>W</mi><mi>i</mi></msub><mo>,</mo><msub><mi>A</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>∼</mo><mi>P</mi><mo>,</mo><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">(Y_i, W_i, A_i) \sim P, i=1,\ldots,n</annotation></semantics></math>. In the following we are interested in estimating the target parameter <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ψ</mi><mo stretchy="false" form="prefix">(</mo><mi>P</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mo stretchy="false" form="prefix">(</mo><mi>E</mi><mo stretchy="false" form="prefix">[</mo><mi>Y</mi><mo stretchy="false" form="prefix">(</mo><mi>a</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">\psi(P) = (E[Y(a)]</annotation></semantics></math>, where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo stretchy="false" form="prefix">(</mo><mi>a</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">Y(a)</annotation></semantics></math> is the <em>potential outcome</em> we would have observed if treatment <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math> had been administered, possibly contrary to the actual treatment that was observed, i.e., <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>Y</mi><mo stretchy="false" form="prefix">(</mo><mi>A</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">Y = Y(A)</annotation></semantics></math>.</p>
<!-- ```{r plotdag, echo=FALSE, fig.cap="DAG for the statistical model"} -->
<!-- par(mfrow=c(1, 2)) -->
<!-- m <- lvm(Y ~ A + W, A ~ W) -->
<!-- plot(m, plot.engine="Rgraphviz") -->
<!-- m <- lvm(Y ~ a + W) -->
<!-- labels(m) <- c("Y" = "Y(a)") -->
<!-- plot(m, plot.engine="Rgraphviz") -->
<!-- ``` -->
<p>Under the following assumptions</p>
<ol style="list-style-type: decimal">
<li>Stable Unit Treatment Values Assumption (the treatment of a specific subject is not affecting the potential outcome of other subjects)</li>
<li>Positivity, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false" form="prefix">(</mo><mi>A</mi><mo>∣</mo><mi>W</mi><mo stretchy="false" form="postfix">)</mo><mo>&gt;</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">P(A\mid W)&gt;\epsilon</annotation></semantics></math> for some <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi><mo>&gt;</mo><mn>0</mn><mi>.</mi></mrow><annotation encoding="application/x-tex">\epsilon&gt;0.</annotation></semantics></math>
</li>
<li>No unmeasured confounders, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo stretchy="false" form="prefix">(</mo><mi>a</mi><mo stretchy="false" form="postfix">)</mo><mo>⊥</mo><mspace width="-0.167em"></mspace><mspace width="-0.167em"></mspace><mspace width="-0.167em"></mspace><mo>⊥</mo><mi>A</mi><mo stretchy="false" form="prefix">|</mo><mi>W</mi></mrow><annotation encoding="application/x-tex">Y(a)\perp \!\!\! \perp A|W</annotation></semantics></math>
</li>
</ol>
<p>the target parameter can be identified from the observed data distribution as <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false" form="prefix">(</mo><mi>E</mi><mo stretchy="false" form="prefix">[</mo><mi>Y</mi><mo stretchy="false" form="prefix">|</mo><mi>W</mi><mo>,</mo><mi>A</mi><mo>=</mo><mi>a</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>E</mi><mo stretchy="false" form="prefix">(</mo><mi>E</mi><mo stretchy="false" form="prefix">[</mo><mi>Y</mi><mo stretchy="false" form="prefix">(</mo><mi>a</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="prefix">|</mo><mi>W</mi><mo stretchy="false" form="postfix">]</mo><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>E</mi><mo stretchy="false" form="prefix">[</mo><mi>Y</mi><mo stretchy="false" form="prefix">(</mo><mi>a</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">E(E[Y|W,A=a]) = E(E[Y(a)|W]) = E[Y(a)]</annotation></semantics></math> or <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false" form="prefix">[</mo><mi>Y</mi><mi>I</mi><mo stretchy="false" form="prefix">(</mo><mi>A</mi><mo>=</mo><mi>a</mi><mo stretchy="false" form="postfix">)</mo><mi>/</mi><mi>P</mi><mo stretchy="false" form="prefix">(</mo><mi>A</mi><mo>=</mo><mi>a</mi><mo stretchy="false" form="prefix">|</mo><mi>W</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo><mo>=</mo><mi>E</mi><mo stretchy="false" form="prefix">[</mo><mi>Y</mi><mo stretchy="false" form="prefix">(</mo><mi>a</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo><mi>.</mi></mrow><annotation encoding="application/x-tex">E[Y I(A=a)/P(A=a|W)] = E[Y(a)].</annotation></semantics></math></p>
<p>This suggests estimation via either <em>outcome regression</em> (OR, g-computation) or <em>inverse probability weighting</em> (IPW). These can eventually also be combined to a doubly-robust augmented inverse probability weighted (AIPW) estimator.</p>
</div>
<div class="section level2">
<h2 id="simulation">Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h2>
<p>As an illustration we simulate from the following model <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>∼</mo><mi>B</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>o</mi><mi>u</mi><mi>l</mi><mi>l</mi><mi>i</mi><mo stretchy="false" form="prefix">(</mo><mo>expit</mo><mo stretchy="false" form="prefix">{</mo><mi>A</mi><mo>+</mo><mi>X</mi><mo>+</mo><mi>Z</mi><mo stretchy="false" form="postfix">}</mo><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">Y \sim Bernoulli(\operatorname{expit}\{A+X+Z\})</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>∼</mo><mi>B</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>o</mi><mi>u</mi><mi>l</mi><mi>l</mi><mi>i</mi><mo stretchy="false" form="prefix">(</mo><mo>expit</mo><mo stretchy="false" form="prefix">{</mo><mi>X</mi><mo>+</mo><mi>Z</mi><mo stretchy="false" form="postfix">}</mo><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">A \sim Bernoulli(\operatorname{expit}\{X+Z\})</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>∼</mo><mstyle mathvariant="script"><mi>𝒩</mi></mstyle><mo stretchy="false" form="prefix">(</mo><mi>X</mi><mo>,</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">Z \sim \mathcal{N}(X,1)</annotation></semantics></math></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kkholst.github.io/lava/reference/lvm.html" class="external-link">lvm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">A</span><span class="op">+</span><span class="va">X</span><span class="op">+</span><span class="va">Z</span>, <span class="va">A</span><span class="op">~</span><span class="va">X</span><span class="op">+</span><span class="va">Z</span>, <span class="va">Z</span><span class="op">~</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kkholst.github.io/lava/reference/sim.html" class="external-link">distribution</a></span><span class="op">(</span><span class="va">m</span>, <span class="op">~</span><span class="va">A</span><span class="op">+</span><span class="va">Y</span>, <span class="fu"><a href="https://kkholst.github.io/lava/reference/sim.html" class="external-link">binomial.lvm</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kkholst.github.io/lava/reference/sim.html" class="external-link">sim</a></span><span class="op">(</span><span class="va">m</span>, <span class="fl">1e3</span>, seed<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Y A          X          Z</span></span>
<span><span class="co">#&gt; 1 0 0 -0.6264538  0.5085113</span></span>
<span><span class="co">#&gt; 2 1 1  0.1836433  1.2955752</span></span>
<span><span class="co">#&gt; 3 0 0 -0.8356286 -1.7064062</span></span>
<span><span class="co">#&gt; 4 1 1  1.5952808  1.8060124</span></span>
<span><span class="co">#&gt; 5 1 0  0.3295078  0.3989034</span></span>
<span><span class="co">#&gt; 6 0 0 -0.8204684 -2.4831172</span></span></code></pre></div>
<!-- ```{r plotdag, echo=FALSE, fig.cap="DAG for the simulated model."} -->
<!-- plot(m) -->
<!-- ``` -->
</div>
<div class="section level2">
<h2 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h2>
<p>The target parameter, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo stretchy="false" form="prefix">[</mo><mi>Y</mi><mo stretchy="false" form="prefix">(</mo><mi>a</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">E[Y(a)]</annotation></semantics></math> can be estimated with the <code><a href="../reference/ate.html">targeted::ate</a></code> function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html" class="external-link">args</a></span><span class="op">(</span><span class="va">ate</span><span class="op">)</span></span>
<span><span class="co">#&gt; function (formula, data = parent.frame(), weights, offset, family = stats::gaussian(identity), </span></span>
<span><span class="co">#&gt;     nuisance = NULL, propensity = nuisance, all, labels = NULL, </span></span>
<span><span class="co">#&gt;     ...) </span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>The formula should be specified as <code>formula = response ~ treatment</code>, and the outcome regression specified as <code>nuisance = ~ covariates</code>, and propensity model <code>propensity = ~ covariates</code>. Alternatively, the formula can be specified with the notation <code>formula = response ~ treatment | OR-covariates | propensity-covariates</code>. <em>Parametric models</em> are assumed for both the outcome regression and the propensity model which defaults to be logistic regression models (as in the simulation). A linear model can be used for the outcome regression part by setting <code>binary=FALSE</code>.</p>
<p>To illustrate this, we can estimate the (non-causal) marginal mean of each treatment value</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ate.html">ate</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">A</span>, data<span class="op">=</span><span class="va">d</span>, nuisance<span class="op">=</span><span class="op">~</span><span class="fl">1</span>, propensity<span class="op">=</span><span class="op">~</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Estimate Std.Err   2.5%  97.5%   P-value</span></span>
<span><span class="co">#&gt; A=0   0.2937 0.02029 0.2539 0.3334 1.741e-47</span></span>
<span><span class="co">#&gt; A=1   0.8367 0.01660 0.8042 0.8692 0.000e+00</span></span></code></pre></div>
<p>or equivalently</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ate.html">ate</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">A</span> <span class="op">|</span> <span class="fl">1</span> <span class="op">|</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Estimate Std.Err   2.5%  97.5%   P-value</span></span>
<span><span class="co">#&gt; A=0   0.2937 0.02029 0.2539 0.3334 1.741e-47</span></span>
<span><span class="co">#&gt; A=1   0.8367 0.01660 0.8042 0.8692 0.000e+00</span></span></code></pre></div>
<p>In this simulation we can compare the estimates to the actual expected potential outcomes which can be approximated by Monte Carlo integration by simulating from the model where we intervene on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math> (i.e., break the dependence on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>,</mo><mi>Z</mi></mrow><annotation encoding="application/x-tex">X, Z</annotation></semantics></math>):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://kkholst.github.io/lava/reference/sim.html" class="external-link">sim</a></span><span class="op">(</span><span class="fu"><a href="https://kkholst.github.io/lava/reference/intervention.lvm.html" class="external-link">intervention</a></span><span class="op">(</span><span class="va">m</span>, <span class="st">"A"</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fl">2e5</span><span class="op">)</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.50034</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://kkholst.github.io/lava/reference/sim.html" class="external-link">sim</a></span><span class="op">(</span><span class="fu"><a href="https://kkholst.github.io/lava/reference/intervention.lvm.html" class="external-link">intervention</a></span><span class="op">(</span><span class="va">m</span>, <span class="st">"A"</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">2e5</span><span class="op">)</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.63689</span></span></code></pre></div>
<p>The IPW estimator can then be estimated</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ate.html">ate</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">A</span> <span class="op">|</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">X</span><span class="op">+</span><span class="va">Z</span>, data<span class="op">=</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Estimate Std.Err   2.5%  97.5%   P-value</span></span>
<span><span class="co">#&gt; A=0   0.4793 0.02678 0.4268 0.5318 1.278e-71</span></span>
<span><span class="co">#&gt; A=1   0.6669 0.03263 0.6029 0.7308 7.528e-93</span></span></code></pre></div>
<p>Similarly, the OR estimator is obtained by</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ate.html">ate</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">A</span> <span class="op">|</span> <span class="va">A</span><span class="op">*</span><span class="op">(</span><span class="va">X</span><span class="op">+</span><span class="va">Z</span><span class="op">)</span> <span class="op">|</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Estimate Std.Err   2.5%  97.5%    P-value</span></span>
<span><span class="co">#&gt; A=0   0.4858 0.02796 0.4310 0.5406  1.243e-67</span></span>
<span><span class="co">#&gt; A=1   0.7213 0.02600 0.6703 0.7723 2.248e-169</span></span></code></pre></div>
<p>Both estimates are in this case consistent though we can see that the OR estimate is much more efficient compared to the IPW estimator. However, both of these models rely on correct model specifications.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ate.html">ate</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">A</span> <span class="op">|</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">X</span>, data<span class="op">=</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Estimate Std.Err   2.5%  97.5%   P-value</span></span>
<span><span class="co">#&gt; A=0   0.4208 0.02706 0.3678 0.4739 1.543e-54</span></span>
<span><span class="co">#&gt; A=1   0.7072 0.03366 0.6412 0.7731 5.204e-98</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ate.html">ate</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">A</span> <span class="op">|</span> <span class="va">A</span><span class="op">*</span><span class="va">X</span> <span class="op">|</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Estimate Std.Err   2.5%  97.5%    P-value</span></span>
<span><span class="co">#&gt; A=0   0.4240 0.02617 0.3727 0.4752  4.794e-59</span></span>
<span><span class="co">#&gt; A=1   0.7474 0.02411 0.7001 0.7946 5.297e-211</span></span></code></pre></div>
<p>In contrast, the doubly-robust AIPW estimator is consistent in the <em>intersection model</em> where either the propensity model or the outcome regression model is correctly specified</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ate.html">ate</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">A</span> <span class="op">|</span> <span class="va">A</span><span class="op">*</span><span class="va">X</span> <span class="op">|</span> <span class="va">X</span><span class="op">+</span><span class="va">Z</span>, data<span class="op">=</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Augmented Inverse Probability Weighting estimator</span></span>
<span><span class="co">#&gt;   Response Y (Outcome model: gaussian):</span></span>
<span><span class="co">#&gt;   Y ~ A * X </span></span>
<span><span class="co">#&gt;   Exposure A (Propensity model: logistic regression):</span></span>
<span><span class="co">#&gt;   A ~ X + Z </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                    Estimate Std.Err    2.5%    97.5%    P-value</span></span>
<span><span class="co">#&gt;  A=0               0.492322 0.02609  0.4412  0.54346  2.028e-79</span></span>
<span><span class="co">#&gt;  A=1               0.663735 0.03068  0.6036  0.72386 8.429e-104</span></span>
<span><span class="co">#&gt; Outcome model:                                                 </span></span>
<span><span class="co">#&gt;  (Intercept)       0.426675 0.02498  0.3777  0.47563  2.048e-65</span></span>
<span><span class="co">#&gt;  A                 0.322545 0.03399  0.2559  0.38916  2.303e-21</span></span>
<span><span class="co">#&gt;  X                 0.232605 0.01825  0.1968  0.26837  3.266e-37</span></span>
<span><span class="co">#&gt;  A:X              -0.075738 0.02609 -0.1269 -0.02461  3.693e-03</span></span>
<span><span class="co">#&gt; Propensity model:                                              </span></span>
<span><span class="co">#&gt;  (Intercept)      -0.006421 0.08337 -0.1698  0.15699  9.386e-01</span></span>
<span><span class="co">#&gt;  X                -0.863004 0.12123 -1.1006 -0.62539  1.091e-12</span></span>
<span><span class="co">#&gt;  Z                -1.005211 0.09080 -1.1832 -0.82725  1.742e-28</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Average Treatment Effect (constrast: 'A=1' - 'A=0'):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Estimate Std.Err    2.5%  97.5%   P-value</span></span>
<span><span class="co">#&gt; ATE   0.1714 0.03661 0.09967 0.2432 2.831e-06</span></span></code></pre></div>
<p>From the <code>summary</code> output we also get the estimates of the Average Treatment Effects expressed as a causal relative risk (RR), causal odds ratio (OR), or causal risk difference (RD) including the confidence limits.</p>
<p>From the model object <code>a</code> we can extract the estimated coefficients (expected potential outcomes) and corresponding asympotic variance matrix with the <code>coef</code> and <code>vcov</code> methods. The estimated <em>influence function</em> can extracted with the <code>iid</code> method:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span><span class="co">#&gt;       A=0       A=1 </span></span>
<span><span class="co">#&gt; 0.4923220 0.6637346</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span><span class="co">#&gt;              A=0          A=1</span></span>
<span><span class="co">#&gt; A=0 0.0006807275 0.0001409887</span></span>
<span><span class="co">#&gt; A=1 0.0001409887 0.0009411920</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://kkholst.github.io/lava/reference/iid.html" class="external-link">iid</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             A=0           A=1</span></span>
<span><span class="co">#&gt; 1 -0.0012182867 -0.0002821609</span></span>
<span><span class="co">#&gt; 2  0.0002438822  0.0002898771</span></span>
<span><span class="co">#&gt; 3 -0.0004583641 -0.0002555994</span></span>
<span><span class="co">#&gt; 4  0.0003753253  0.0002567340</span></span>
<span><span class="co">#&gt; 5  0.0011971267  0.0001267515</span></span>
<span><span class="co">#&gt; 6 -0.0004585485 -0.0001710518</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multiple-treatments">Multiple treatments<a class="anchor" aria-label="anchor" href="#multiple-treatments"></a>
</h2>
<p>As an example with multiple treatment levels, we simulate from a new model where the outcome is continuous and the treatment follows a proportional odds model</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kkholst.github.io/lava/reference/lvm.html" class="external-link">lvm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">a</span><span class="op">+</span><span class="va">x</span>, <span class="va">a</span><span class="op">~</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kkholst.github.io/lava/reference/ordinal-set.html" class="external-link">ordinal</a></span><span class="op">(</span><span class="va">m</span>, K<span class="op">=</span><span class="fl">4</span>, <span class="op">~</span><span class="va">a</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="fu"><a href="https://kkholst.github.io/lava/reference/sim.html" class="external-link">sim</a></span><span class="op">(</span><span class="va">m</span>, <span class="fl">1e4</span><span class="op">)</span>, a<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The AIPW estimator is obtained by estimating a logistic regression model for each treatment level (vs all others) in the propensity model (here a correct model is specified for both the OR and IPW part)</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">a2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ate.html">ate</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">a</span> <span class="op">|</span> <span class="va">a</span><span class="op">*</span><span class="va">x</span> <span class="op">|</span> <span class="va">x</span>, data<span class="op">=</span><span class="va">d</span>, binary<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Augmented Inverse Probability Weighting estimator</span></span>
<span><span class="co">#&gt;   Response y (Outcome model: gaussian):</span></span>
<span><span class="co">#&gt;   y ~ a * x </span></span>
<span><span class="co">#&gt;   Exposure a (Propensity model: logistic regression):</span></span>
<span><span class="co">#&gt;   a ~ x </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Estimate Std.Err    2.5%   97.5%    P-value</span></span>
<span><span class="co">#&gt; a=0  -1.5792 0.03928 -1.6562 -1.5022  0.000e+00</span></span>
<span><span class="co">#&gt; a=1  -0.7682 0.04115 -0.8489 -0.6876  8.723e-78</span></span>
<span><span class="co">#&gt; a=2  -0.4171 0.03548 -0.4866 -0.3475  6.582e-32</span></span>
<span><span class="co">#&gt; a=3   0.7470 0.02424  0.6995  0.7945 1.340e-208</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Average Treatment Effect (constrast: 'a=1' - 'a=0'):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Estimate Std.Err   2.5% 97.5%   P-value</span></span>
<span><span class="co">#&gt; ATE    0.811 0.05461 0.7039 0.918 7.044e-50</span></span></code></pre></div>
<p>Choosing a different contrast for the association measures:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">a2</span>, contrast<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Augmented Inverse Probability Weighting estimator</span></span>
<span><span class="co">#&gt;   Response y (Outcome model: gaussian):</span></span>
<span><span class="co">#&gt;   y ~ a * x </span></span>
<span><span class="co">#&gt;   Exposure a (Propensity model: logistic regression):</span></span>
<span><span class="co">#&gt;   a ~ x </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Estimate Std.Err    2.5%   97.5%    P-value</span></span>
<span><span class="co">#&gt; a=0  -1.5792 0.03928 -1.6562 -1.5022  0.000e+00</span></span>
<span><span class="co">#&gt; a=1  -0.7682 0.04115 -0.8489 -0.6876  8.723e-78</span></span>
<span><span class="co">#&gt; a=2  -0.4171 0.03548 -0.4866 -0.3475  6.582e-32</span></span>
<span><span class="co">#&gt; a=3   0.7470 0.02424  0.6995  0.7945 1.340e-208</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Average Treatment Effect (constrast: 'a=1' - 'a=3'):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Estimate Std.Err   2.5%  97.5%    P-value</span></span>
<span><span class="co">#&gt; ATE   -1.515 0.04424 -1.602 -1.429 3.985e-257</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://kkholst.github.io/lava/reference/iid.html" class="external-link">iid</a></span><span class="op">(</span><span class="va">a2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             a=0           a=1           a=2           a=3</span></span>
<span><span class="co">#&gt; 1 -6.051178e-04  3.348572e-05  3.188711e-05  4.116160e-05</span></span>
<span><span class="co">#&gt; 2 -9.227453e-05  2.809195e-04 -6.091591e-05 -7.910553e-05</span></span>
<span><span class="co">#&gt; 3  1.554332e-04  1.229831e-04  1.160951e-04  2.360075e-04</span></span>
<span><span class="co">#&gt; 4  4.581986e-05  4.615912e-05 -3.669610e-04  5.317770e-05</span></span>
<span><span class="co">#&gt; 5 -3.005632e-04 -2.050601e-04 -1.952828e-04 -3.077626e-04</span></span>
<span><span class="co">#&gt; 6  1.699202e-04  1.334874e-04  1.259713e-04  1.760130e-04</span></span>
<span><span class="fu"><a href="https://kkholst.github.io/lava/reference/estimate.default.html" class="external-link">estimate</a></span><span class="op">(</span><span class="va">a2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Estimate Std.Err   2.5%  97.5%    P-value</span></span>
<span><span class="co">#&gt; a=1   -1.515 0.04424 -1.602 -1.429 3.985e-257</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sessioninfo">SessionInfo<a class="anchor" aria-label="anchor" href="#sessioninfo"></a>
</h2>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.4.2 (2024-10-31)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 22.04.5 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] targeted_0.6 lava_1.8.0  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] Matrix_1.7-1        future.apply_1.11.3 jsonlite_1.8.9     </span></span>
<span><span class="co">#&gt;  [4] compiler_4.4.2      Rcpp_1.0.13-1       parallel_4.4.2     </span></span>
<span><span class="co">#&gt;  [7] jquerylib_0.1.4     globals_0.16.3      splines_4.4.2      </span></span>
<span><span class="co">#&gt; [10] systemfonts_1.1.0   textshaping_0.4.0   yaml_2.3.10        </span></span>
<span><span class="co">#&gt; [13] fastmap_1.2.0       lattice_0.22-6      R6_2.5.1           </span></span>
<span><span class="co">#&gt; [16] knitr_1.49          future_1.34.0       nloptr_2.1.1       </span></span>
<span><span class="co">#&gt; [19] desc_1.4.3          bslib_0.8.0         rlang_1.1.4        </span></span>
<span><span class="co">#&gt; [22] cachem_1.1.0        xfun_0.49           fs_1.6.5           </span></span>
<span><span class="co">#&gt; [25] sass_0.4.9          cli_3.6.3           pkgdown_2.1.1      </span></span>
<span><span class="co">#&gt; [28] digest_0.6.37       grid_4.4.2          mvtnorm_1.3-2      </span></span>
<span><span class="co">#&gt; [31] lifecycle_1.0.4     timereg_2.0.6       evaluate_1.0.1     </span></span>
<span><span class="co">#&gt; [34] pracma_2.4.4        data.table_1.16.2   numDeriv_2016.8-1.1</span></span>
<span><span class="co">#&gt; [37] listenv_0.9.1       codetools_0.2-20    ragg_1.3.3         </span></span>
<span><span class="co">#&gt; [40] survival_3.7-0      optimx_2023-10.21   parallelly_1.39.0  </span></span>
<span><span class="co">#&gt; [43] rmarkdown_2.29      mets_1.3.4          tools_4.4.2        </span></span>
<span><span class="co">#&gt; [46] htmltools_0.5.8.1</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Klaus K. Holst, Andreas Nordland.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
